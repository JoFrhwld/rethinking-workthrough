{
  "hash": "a19ca62f3511d7ef8e7eb9785637c6e9",
  "result": {
    "markdown": "---\ntitle: \"Multicollinearity & Post-treatment bias\"\norder: 16\ndate: 2023-09-05\ntwitter-card: true\nopen-graph: true\n---\n\n\n::: callout-note\n## Listening\n\n<iframe style=\"border-radius:12px\" src=\"https://open.spotify.com/embed/track/1TfqLAPs4K3s2rJMoCokcS?utm_source=generator\" width=\"100%\" height=\"152\" frameBorder=\"0\" allowfullscreen allow=\"autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture\" loading=\"lazy\">\n\n</iframe>\n:::\n\n## Setup\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(tidyverse)\nlibrary(tidybayes)\nlibrary(brms)\nlibrary(gt)\nlibrary(gtsummary)\nlibrary(patchwork)\nlibrary(ggblend)\nlibrary(ggdensity)\nlibrary(ggforce)\nlibrary(marginaleffects)\nlibrary(dagitty)\nlibrary(ggdag)\nlibrary(GGally)\n\n\nsource(here::here(\"_defaults.r\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(2023-9-5)\n```\n:::\n\n\n## What to (not) do\n\nHere's what McElreath says about multicollinearity\n\n> Some fields actually teach students to inspect pairwise correlations before fitting a model, to identify and drop highly correlated predictors. **This is a mistake.** Pairwise correlations are not the problem. It is the conditional associations---not correlations---that matter. (*emphasis added*)\n\n## A real multicollinear example\n\nA real multicollinear example involves the percent fat and lactose in primate's milk when used to predict the kcal.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(milk, package = \"rethinking\")\n```\n:::\n\n::: {.cell filename='preparing data'}\n\n```{.r .cell-code}\nmilk |> \n  drop_na(\n    kcal.per.g, \n    perc.fat, \n    perc.lactose\n  ) |> \n  mutate(\n    kcal_z = (kcal.per.g-mean(kcal.per.g))/sd(kcal.per.g),\n    fat_z = (perc.fat - mean(perc.fat))/sd(perc.fat),\n    lactose_z = (perc.lactose - mean(perc.lactose))/sd(perc.lactose)\n  )->\n  milk_to_mod\n```\n:::\n\n\nI wanted to make a pairs plot with `GGally::pairs()`, but something is busted with the axes. I'll have to do it a little by hand.\n\n\n::: {.cell filename='GGally::pairs() attempt'}\n\n```{.r .cell-code}\nmilk_to_mod |> \n  select(\n    ends_with(\"_z\")\n  ) |> \n  GGally::ggpairs()\n```\n\n::: {.cell-output-display}\n![pairs plot of the primate milk data](index_files/figure-html/fig-pairs1-1.png){#fig-pairs1 width=80%}\n:::\n:::\n\n::: {.cell crop='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nmilk_to_mod |> \n  ggplot(aes(lactose_z, kcal_z)) +\n    geom_point()->\n  a\n\nmilk_to_mod |> \n  ggplot(aes(fat_z, kcal_z))+\n    geom_point()+\n    theme_blank_y()->\n  b\n\nmilk_to_mod |> \n  ggplot(aes(lactose_z, fat_z))+\n    geom_point()+\n    theme_blank_x()->\n  c\n\nthis_layout <- \"\nC#\nAB\n\"\n\na+b+c + plot_layout(design = this_layout)\n```\n\n::: {.cell-output-display}\n![Pairs plot](index_files/figure-html/fig-pairs2-1.png){#fig-pairs2 width=80%}\n:::\n:::\n\n\nOk, now I'll fit models for\n\n```         \nkcal_z ~ lactose_z\nkcal_z ~ fat_z\nkcal_z ~ lactose_z + fat_z\n```\n\nwith the same priors from the book.\n\n\n::: {.cell filename='model priors'}\n\n```{.r .cell-code}\nmilk_prior <- c(\n  prior(normal(0, 0.2), class = Intercept),\n  prior(normal(0, 0.5), class = b)\n)\n```\n:::\n\n::: {.cell filename='lactose model'}\n\n```{.r .cell-code}\nbrm(\n  kcal_z ~ lactose_z,\n  prior = milk_prior,\n  data = milk_to_mod,\n  backend = \"cmdstanr\",\n  cores = 4,\n  file = \"kcal_lact_mod\" \n)->\n  kcal_lact_mod\n```\n:::\n\n::: {.cell filename='fat model'}\n\n```{.r .cell-code}\nbrm(\n  kcal_z ~ fat_z,\n  prior = milk_prior,\n  data = milk_to_mod,\n  backend = \"cmdstanr\",\n  cores = 4,\n  file = \"kcal_fat_mod\" \n)->\n  kcal_fat_mod\n```\n:::\n\n::: {.cell filename='lactose and fat model'}\n\n```{.r .cell-code}\nbrm(\n  kcal_z ~ lactose_z + fat_z,\n  prior = milk_prior,\n  data = milk_to_mod,\n  backend = \"cmdstanr\",\n  cores = 4,\n  file = \"kcal_lact_fat_mod\" \n)->\n  kcal_lact_fat_mod\n```\n:::\n\n\nNow to compare the estimates\n\n::: {.callout-note collapse=\"true\"}\n## a function\n\nI should really refactor the code chunk below into its own function, but the nonstandard evaluation of `gather_draws()` is intimidating to me.\n:::\n\n\n::: {.cell filename='getting all betas'}\n\n```{.r .cell-code}\nlist(\n  lact = kcal_lact_mod,\n  fat = kcal_fat_mod,\n  lact_fat = kcal_lact_fat_mod\n) |> \n  map(\n    ~ .x |> \n      gather_draws(\n        `b_.*`,\n        regex = T\n      )\n  ) |> \n  list_rbind(\n    names_to = \"model\"\n  ) ->\n  all_milk_params\n```\n:::\n\n\nWe only want to look at the non-intercept parameters.\n\n\n::: {.cell filename='dropping intercepts'}\n\n```{.r .cell-code}\nall_milk_params |> \n  filter(\n    str_detect(\n      .variable, \n      \"Intercept\", \n      negate = T\n    )\n  ) ->\n  milk_betas\n```\n:::\n\n::: {.cell crop='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nmilk_betas |> \n  mutate(\n    model = str_c(\n      \"~\", \n      model\n    ) |> \n      str_replace(\n        \"_\",\n        \"+\"\n      )\n  ) |> \n  ggplot(\n    aes(\n      .value,\n      .variable,\n      color = model\n    )\n  )+\n    geom_vline(\n      xintercept = 0\n    )+\n    stat_pointinterval(\n      position = position_dodge(width = 0.2)\n    )\n```\n\n::: {.cell-output-display}\n![Parameter comparison](index_files/figure-html/fig-milk-param-1.png){#fig-milk-param width=80%}\n:::\n:::\n\n\nSo, in each separate model, lactose and fat have larger magnitudes than in the model with both.\n\nLets grab the correlation of the parameters in the full model.\n\n\n::: {.cell filename='getting parameter correlation.'}\n\n```{.r .cell-code}\nall_milk_params |> \n  filter(\n    model == \"lact_fat\"\n  ) |> \n  pivot_wider(\n    names_from = .variable,\n    values_from = .value\n  ) |> \n  select(\n    starts_with(\"b_\")\n  ) |> \n  cor() ->\n  milk_param_cor\n\nmilk_param_cor\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            b_Intercept b_lactose_z    b_fat_z\nb_Intercept  1.00000000  0.01948817 0.02332534\nb_lactose_z  0.01948817  1.00000000 0.92006316\nb_fat_z      0.02332534  0.92006316 1.00000000\n```\n:::\n:::\n\n\nFor fun, let's make this cleaner for `gt`\n\n\n::: {#tbl-param-cor .cell tbl-cap='Parameter posterior correlation'}\n\n```{.r .cell-code  code-fold=\"true\"}\nmilk_param_cor[\n  upper.tri(milk_param_cor, diag = T)\n] <- NA\n\nmilk_param_cor |> \n  as_tibble(rownames = \"param\") |> \n  slice(-1) |> \n  select(-b_fat_z) |> \n  gt() |> \n  sub_missing() |> \n  fmt_number() |> \n  cols_label(\n    param = \"\"\n  ) \n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"wzgnfeuwiy\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#wzgnfeuwiy table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#wzgnfeuwiy thead, #wzgnfeuwiy tbody, #wzgnfeuwiy tfoot, #wzgnfeuwiy tr, #wzgnfeuwiy td, #wzgnfeuwiy th {\n  border-style: none;\n}\n\n#wzgnfeuwiy p {\n  margin: 0;\n  padding: 0;\n}\n\n#wzgnfeuwiy .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#wzgnfeuwiy .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#wzgnfeuwiy .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#wzgnfeuwiy .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#wzgnfeuwiy .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#wzgnfeuwiy .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#wzgnfeuwiy .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#wzgnfeuwiy .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#wzgnfeuwiy .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#wzgnfeuwiy .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#wzgnfeuwiy .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#wzgnfeuwiy .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#wzgnfeuwiy .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#wzgnfeuwiy .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#wzgnfeuwiy .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wzgnfeuwiy .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#wzgnfeuwiy .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#wzgnfeuwiy .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#wzgnfeuwiy .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wzgnfeuwiy .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#wzgnfeuwiy .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wzgnfeuwiy .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#wzgnfeuwiy .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wzgnfeuwiy .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#wzgnfeuwiy .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#wzgnfeuwiy .gt_left {\n  text-align: left;\n}\n\n#wzgnfeuwiy .gt_center {\n  text-align: center;\n}\n\n#wzgnfeuwiy .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#wzgnfeuwiy .gt_font_normal {\n  font-weight: normal;\n}\n\n#wzgnfeuwiy .gt_font_bold {\n  font-weight: bold;\n}\n\n#wzgnfeuwiy .gt_font_italic {\n  font-style: italic;\n}\n\n#wzgnfeuwiy .gt_super {\n  font-size: 65%;\n}\n\n#wzgnfeuwiy .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#wzgnfeuwiy .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#wzgnfeuwiy .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#wzgnfeuwiy .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#wzgnfeuwiy .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#wzgnfeuwiy .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#wzgnfeuwiy .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"\"></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"b_Intercept\">b_Intercept</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"b_lactose_z\">b_lactose_z</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"param\" class=\"gt_row gt_left\">b_lactose_z</td>\n<td headers=\"b_Intercept\" class=\"gt_row gt_right\">0.02</td>\n<td headers=\"b_lactose_z\" class=\"gt_row gt_right\">—</td></tr>\n    <tr><td headers=\"param\" class=\"gt_row gt_left\">b_fat_z</td>\n<td headers=\"b_Intercept\" class=\"gt_row gt_right\">0.02</td>\n<td headers=\"b_lactose_z\" class=\"gt_row gt_right\">0.92</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\nNotably, the correlation of the `b_fat_z` and the `b_lactose_z` parameters ≠ the correlation of the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(milk_to_mod |> \n  select(\n    lactose_z,\n    fat_z\n  ) |> \n  cor())[1,2]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] -0.9416373\n```\n:::\n:::\n\n\nHere's a visual comparison of the original data versus the posterior estimates for the effect of the variables.\n\n\n::: {.cell crop='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nmilk_to_mod |> \n  ggplot(\n    aes(\n      lactose_z,\n      fat_z\n    )\n  )+\n    geom_point()+\n    labs(\n      title = \"data\"\n    )->\n  data_cor\n\nall_milk_params |> \n  filter(\n    model == \"lact_fat\"\n  ) |> \n  pivot_wider(\n    names_from = .variable,\n    values_from = .value\n  ) |> \n  ggplot(\n    aes(\n      b_lactose_z, \n      b_fat_z\n    )\n  )+\n    stat_hdr_points()+\n    guides(\n      color = \"none\"\n    ) +\n    labs(title = \"posterior\")->\n  posterior_cor\n\ndata_cor + posterior_cor\n```\n\n::: {.cell-output-display}\n![Data vs Posterior parameters](index_files/figure-html/fig-data-v-post-1.png){#fig-data-v-post width=80%}\n:::\n:::\n\n\nMcElreath says one thing to do is compare the posterior to the prior. Very similar posteriors and priors could indicate identifiability problems.\n\n\n::: {.cell crop='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nall_milk_params |> \n  filter(\n    model == \"lact_fat\",\n    .variable %in% c(\"b_lactose_z\", \"b_fat_z\")\n  ) |> \n  ggplot(\n    aes(\n      .value\n    )\n  )+\n  stat_density(\n    aes(\n      color=\"posterior\"\n    ),\n    geom = \"line\"\n  )+\n  stat_function(\n    fun = dnorm,\n    args = list(\n      mean = 0,\n      sd = 0.5\n    ),\n    aes(\n      color = \"prior\"\n    )\n  ) +\n  facet_wrap(\n    ~.variable\n  )+\n  xlim(\n    0.5 * -3,\n    0.5 * 3\n  )+\n  labs(\n    color = NULL,\n    x = NULL\n  )+\n  theme_no_y()+\n  theme(\n    aspect.ratio = 0.8\n  )\n```\n\n::: {.cell-output-display}\n![Prior/Posterior comparison](index_files/figure-html/fig-prior-post-1.png){#fig-prior-post width=80%}\n:::\n:::\n\n\n## Post-treatment bias\n\nMaking this work is going to involve both wrapping my mind around a post-treatment bias, and figuring out how to set a lognormal prior or family in brms.\n\nThe hypothetical situation: You're testing different antifungal soils on plant growth, and you're measuring their height, and the presence/absence of fungus. The chronological process is something like:\n\n\n```{mermaid}\nflowchart LR\n  a[measure sprouts]\n  b(treat soil)\n  a --> b\n  c[measure plants]\n  d[record fungus]\n  b --> c\n  b --> d\n```\n\n\nThe causal process might be something like\n\n\n```{mermaid}\ngraph LR\n  h0[initial height]\n  h1[second height]\n  f[fungus]\n  t[treatment]\n  \n  h0 --> h1\n  f --> h1\n  t --> f\n```\n\n\nThis makes it much clearer now! \"Post treatment\" meaning \"a variable that sits between the treatment and the outcome.\"\n\n\n::: {.cell filename='fungus simulation'}\n\n```{.r .cell-code}\nn = 100\ntibble(\n  plant_id = 1:n,\n  treatment = plant_id %% 2,\n  h0 = rnorm(n, 10, 2),\n  fungus = rbinom(\n    100,\n    size = 1,\n    prob = 0.5 - treatment * 0.4\n  ),\n  h1 = h0 + \n    rnorm(\n      n, \n      mean = 5 - 3 * fungus\n    )\n)->\n  fungus_sim\n```\n:::\n\n::: {.cell layout-ncol=\"2\" crop='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nfungus_sim |> \n  ggplot(\n    aes(\n      h0,\n      h1,\n      color = factor(treatment)\n    )\n  )+\n    geom_point()+\n    geom_abline(color = \"grey60\")+\n    labs(\n      color = \"treatment\"\n    )+\n  theme(\n    legend.position = \"top\",\n    aspect.ratio = NULL\n  )+\n  coord_fixed()->\n  fungus1\n\nfungus_sim |> \n  ggplot(\n    aes(\n      h0,\n      h1,\n      color = factor(fungus)\n    )\n  )+\n    geom_point()+\n    geom_abline(color = \"grey60\")+\n    labs(\n      color = \"fungus\"\n    )+\n    scale_color_brewer(\n      palette = \"Dark2\"\n    )+\n  theme(\n    legend.position = \"top\",\n    aspect.ratio = NULL\n  )+\n  coord_fixed()->\n  fungus2\n\nfungus1 + fungus2\n```\n\n::: {.cell-output-display}\n![plant hight, comparing treatment vs fungus effects](index_files/figure-html/fig-fungus-comp-1.png){#fig-fungus-comp width=576}\n:::\n:::\n\n\n### Fitting the model\n\nThe way the book fits the model is to use a multiplier on `h0`. To get this to work in `brm()` , I think I need to use its [non-linear modelling](https://cran.r-project.org/web/packages/brms/vignettes/brms_nonlinear.html) capacity.\n\nFirst, we fit just an across-the-board model, without including treatment or fungus\n\n\n::: {.cell filename='growth only model'}\n\n```{.r .cell-code}\nbrm(\n  bf(\n    h1 ~ h0 * p,\n    p ~ 1,\n    nl = T\n  ),\n  prior = c(\n    prior(lognormal(0, 0.25), coef = Intercept, nlpar = p)\n  ),\n  data = fungus_sim,\n  backend = \"cmdstanr\",\n  file = \"fungus1\"\n)->\n  fungus1_mod\n```\n:::\n\n::: {.cell filename='getting growth estimate'}\n\n```{.r .cell-code}\nfungus1_mod |> \n  gather_draws(\n    `b_.*`,\n    regex = T\n  ) -> fungus1_params\n```\n:::\n\n::: {.cell crop='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nfungus1_params |> \n  ggplot(\n    aes(\n      .value, \n      .variable\n    )\n  )+\n    stat_halfeye()\n```\n\n::: {.cell-output-display}\n![Estimated growth-only model](index_files/figure-html/fig-growth-param-1.png){#fig-growth-param width=80%}\n:::\n:::\n\n\nThis is, thankfully, very similar to what the posterior from the book was! So maybe I did it right. Let's grab the maximum likelihood estimate from the simulated data.\n\n\n::: {#tbl-makl .cell filename='data summary stats' tbl-cap='Summary stats of the growth data.'}\n\n```{.r .cell-code}\nfungus_sim |> \n  mutate(\n    p = h1/h0\n  ) |> \n  reframe(\n    stat = c(\"median\", \"mean\", \"logmean\"),\n    value = c(\n      median(p),\n      mean(p),\n      exp(mean(log(p)))\n    )\n  ) |> \n  gt() |> \n  fmt_number()\n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"fpczfkunls\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#fpczfkunls table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#fpczfkunls thead, #fpczfkunls tbody, #fpczfkunls tfoot, #fpczfkunls tr, #fpczfkunls td, #fpczfkunls th {\n  border-style: none;\n}\n\n#fpczfkunls p {\n  margin: 0;\n  padding: 0;\n}\n\n#fpczfkunls .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#fpczfkunls .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#fpczfkunls .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#fpczfkunls .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#fpczfkunls .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#fpczfkunls .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#fpczfkunls .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#fpczfkunls .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#fpczfkunls .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#fpczfkunls .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#fpczfkunls .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#fpczfkunls .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#fpczfkunls .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#fpczfkunls .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#fpczfkunls .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#fpczfkunls .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#fpczfkunls .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#fpczfkunls .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#fpczfkunls .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#fpczfkunls .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#fpczfkunls .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#fpczfkunls .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#fpczfkunls .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#fpczfkunls .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#fpczfkunls .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#fpczfkunls .gt_left {\n  text-align: left;\n}\n\n#fpczfkunls .gt_center {\n  text-align: center;\n}\n\n#fpczfkunls .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#fpczfkunls .gt_font_normal {\n  font-weight: normal;\n}\n\n#fpczfkunls .gt_font_bold {\n  font-weight: bold;\n}\n\n#fpczfkunls .gt_font_italic {\n  font-style: italic;\n}\n\n#fpczfkunls .gt_super {\n  font-size: 65%;\n}\n\n#fpczfkunls .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#fpczfkunls .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#fpczfkunls .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#fpczfkunls .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#fpczfkunls .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#fpczfkunls .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#fpczfkunls .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    \n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"stat\">stat</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"value\">value</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"stat\" class=\"gt_row gt_left\">median</td>\n<td headers=\"value\" class=\"gt_row gt_right\">1.45</td></tr>\n    <tr><td headers=\"stat\" class=\"gt_row gt_left\">mean</td>\n<td headers=\"value\" class=\"gt_row gt_right\">1.43</td></tr>\n    <tr><td headers=\"stat\" class=\"gt_row gt_left\">logmean</td>\n<td headers=\"value\" class=\"gt_row gt_right\">1.42</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\n### Including both predictors\n\nNow we'll do the \"bad\" thing and include both predictors. The book keeps the lognormal prior on the *intercept* of the multiplier, but just a normal prior on the treatment and fungus effects.\n\n\n::: {.cell filename='fungus + treatment model'}\n\n```{.r .cell-code}\nbrm(\n  bf(\n    h1 ~ h0 * p,\n    p ~ treatment + fungus,\n    nl = T\n  ),\n  prior = c(\n    prior(lognormal(0, 0.2), coef = Intercept, nlpar = p),\n    prior(normal(0, 0.5), coef = treatment, nlpar = p),\n    prior(normal(0, 0.5), coef = fungus, nlpar = p)\n  ),\n  data = fungus_sim,\n  backend = \"cmdstanr\",\n  file = \"fungus2\"\n)->\n  fungus2_mod\n```\n:::\n\n::: {.cell filename='getting parameters'}\n\n```{.r .cell-code}\nfungus2_mod |> \n  gather_draws(\n    `b_.*`,\n    regex = T\n  )->\n  fungus2_param\n```\n:::\n\n::: {.cell crop='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nfungus2_param |> \n  mutate(\n    .variable = .variable |> \n      as.factor() |> \n      fct_relevel(\n      \"b_p_Intercept\",\n      after = Inf\n    )\n  ) |> \n  ggplot(\n    aes(\n      .value,\n      .variable\n    )\n  )+\n    geom_vline(xintercept = 0)+\n    stat_halfeye()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-29-1.png){width=576}\n:::\n:::\n\n\nOk, so just like the book\n\n1.  The multiplier intercept got bigger (since it's the growth for treatment=0, fungus=0).\n2.  We've got a negative effect of fungus.\n3.  We've got a weak or 0 effect of treatment.\n\nThe non-effect of treatment makes sense, since the effect of treatment is conditional on the effect of the fungus, and the presence/absence of fungus is itself an outcome of the treatment.\n\nBut, this doesn't mean the treatment didn't work. There are a lot more plants without fungus in the treatment condition than the non-treatment.\n\n\n::: {#tbl-treatment-fungus .cell filename='treatment by fungus' tbl-cap='Treatment by Fungus'}\n\n```{.r .cell-code}\nfungus_sim |> \n  count(\n    treatment, fungus\n  ) |> \n  pivot_wider(\n    names_from = fungus,\n    values_from = n\n  ) |> \n  gt() |> \n  tab_spanner(\n    columns = 2:3,\n    label = \"fungus\"\n  )\n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"kvgrtfbcin\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#kvgrtfbcin table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#kvgrtfbcin thead, #kvgrtfbcin tbody, #kvgrtfbcin tfoot, #kvgrtfbcin tr, #kvgrtfbcin td, #kvgrtfbcin th {\n  border-style: none;\n}\n\n#kvgrtfbcin p {\n  margin: 0;\n  padding: 0;\n}\n\n#kvgrtfbcin .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#kvgrtfbcin .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#kvgrtfbcin .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#kvgrtfbcin .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#kvgrtfbcin .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#kvgrtfbcin .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#kvgrtfbcin .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#kvgrtfbcin .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#kvgrtfbcin .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#kvgrtfbcin .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#kvgrtfbcin .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#kvgrtfbcin .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#kvgrtfbcin .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#kvgrtfbcin .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#kvgrtfbcin .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kvgrtfbcin .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#kvgrtfbcin .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#kvgrtfbcin .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#kvgrtfbcin .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kvgrtfbcin .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#kvgrtfbcin .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kvgrtfbcin .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#kvgrtfbcin .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kvgrtfbcin .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#kvgrtfbcin .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#kvgrtfbcin .gt_left {\n  text-align: left;\n}\n\n#kvgrtfbcin .gt_center {\n  text-align: center;\n}\n\n#kvgrtfbcin .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#kvgrtfbcin .gt_font_normal {\n  font-weight: normal;\n}\n\n#kvgrtfbcin .gt_font_bold {\n  font-weight: bold;\n}\n\n#kvgrtfbcin .gt_font_italic {\n  font-style: italic;\n}\n\n#kvgrtfbcin .gt_super {\n  font-size: 65%;\n}\n\n#kvgrtfbcin .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#kvgrtfbcin .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#kvgrtfbcin .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#kvgrtfbcin .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#kvgrtfbcin .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#kvgrtfbcin .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#kvgrtfbcin .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    \n    <tr class=\"gt_col_headings gt_spanner_row\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"2\" colspan=\"1\" scope=\"col\" id=\"treatment\">treatment</th>\n      <th class=\"gt_center gt_columns_top_border gt_column_spanner_outer\" rowspan=\"1\" colspan=\"2\" scope=\"colgroup\" id=\"fungus\">\n        <span class=\"gt_column_spanner\">fungus</span>\n      </th>\n    </tr>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"0\">0</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"1\">1</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"treatment\" class=\"gt_row gt_right\">0</td>\n<td headers=\"0\" class=\"gt_row gt_right\">29</td>\n<td headers=\"1\" class=\"gt_row gt_right\">21</td></tr>\n    <tr><td headers=\"treatment\" class=\"gt_row gt_right\">1</td>\n<td headers=\"0\" class=\"gt_row gt_right\">47</td>\n<td headers=\"1\" class=\"gt_row gt_right\">3</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n:::\n:::\n\n\n### Treatment only\n\nLet's fit one more model, leaving out fungus.\n\n\n::: {.cell filename='treatment only model'}\n\n```{.r .cell-code}\nbrm(\n  bf(\n    h1 ~ h0 * p,\n    p ~ treatment,\n    nl = T\n  ),\n  prior = c(\n    prior(lognormal(0, 0.2), coef = Intercept, nlpar = p),\n    prior(normal(0, 0.5), coef = treatment, nlpar = p)\n  ),\n  data = fungus_sim,\n  backend = \"cmdstanr\",\n  file = \"fungus3\"\n)->\n  fungus3_mod\n```\n:::\n\n::: {.cell filename='getting treatment only params'}\n\n```{.r .cell-code}\nfungus3_mod |> \n  gather_draws(\n    `b_.*`,\n    regex = T\n  ) ->\n  fungus3_param\n```\n:::\n\n::: {.cell crop='true'}\n\n```{.r .cell-code  code-fold=\"true\"}\nfungus3_param |> \n  ggplot(\n    aes(\n      .value, \n      .variable\n    )\n  )+\n    geom_vline(\n      xintercept = 0\n    ) +\n    stat_halfeye()\n```\n\n::: {.cell-output-display}\n![Estimates from treatment only model.](index_files/figure-html/fig-fungus3-1.png){#fig-fungus3 width=576}\n:::\n:::\n\n\nNow we get a reliable positive effect of treatment.\n\n### Looking at it in a DAG\n\nI'll use the `{ggdag}` and `{dagitty}` packages to build a directed acyclic graph, and then get the \"conditional independencies\" from it.\n\nThe `ggdag::dagify()` function takes a sequence of formulas that translate back and forth between the dags like so:\n\n```         \n# dag\nh0 -> h1\n\n# formula\nh1 ~ h0\n```\n\n\n::: {.cell filename='making the dag'}\n\n```{.r .cell-code}\n# from {ggdag}\ndagify(\n  h1 ~ h0,\n  h1 ~ fungus,\n  fungus ~ treatment\n)->\n  fungus_dag\n```\n:::\n\n::: {.cell filename='getting the independencies'}\n\n```{.r .cell-code}\nimpliedConditionalIndependencies(\n  fungus_dag\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nfngs _||_ h0\nh0 _||_ trtm\nh1 _||_ trtm | fngs\n```\n:::\n:::\n\n\nSo, getting these conditional independence statements to look nice is a whole thing, apparently. There's [a unicode character](https://en.wikipedia.org/wiki/Up_tack), ⫫, but in LaTeX the best option is apparently `\\perp\\!\\!\\!\\perp`, $\\perp\\!\\!\\!\\perp$.\n\nAnyway, the important statement in there is\n\n$$\\text{h}1 \\perp\\!\\!\\!\\perp \\text{treatment}~ |~ \\text{fungus}$$\n\nThis means that if fungus is included, then `h1` (our outcome) is independent from `treatment`, i.e. including the post-treatment effect in the model will make it seem like there's no effect of the treatment.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}